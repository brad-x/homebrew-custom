From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Brad Laue <brad@brad-x.com>
Date: Tue, 17 Feb 2026 00:00:00 +0000
Subject: [PATCH] hw/intc/apic: Restore cpu_reset_interrupt for SIPI in
 apic_sipi()

Commit df32e5c568 ("i386/cpu: Prevent delivering SIPI during SMM in TCG
mode") moved the clearing of CPU_INTERRUPT_SIPI out of the shared
apic_sipi() and into the TCG-only x86_cpu_exec_interrupt() path.

This breaks HVF on x86_64 (Intel Macs), which has its own vCPU run loop
and does not dispatch interrupts through x86_cpu_exec_interrupt(). After
the original commit, CPU_INTERRUPT_SIPI is never cleared under HVF,
causing repeated SIPI delivery and boot failures on SMP guests.

Restore the cpu_reset_interrupt() call in the shared apic_sipi() so that
all accelerators (TCG, KVM, HVF) correctly clear the pending SIPI.

Fixes: df32e5c568 ("i386/cpu: Prevent delivering SIPI during SMM in TCG mode")
Signed-off-by: Brad Laue <brad@brad-x.com>
---
 hw/intc/apic.c | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/hw/intc/apic.c b/hw/intc/apic.c
--- a/hw/intc/apic.c
+++ b/hw/intc/apic.c
@@ -645,6 +645,8 @@
 void apic_sipi(APICCommonState *s)
 {
+    cpu_reset_interrupt(CPU(s->cpu), CPU_INTERRUPT_SIPI);
+
     if (!s->wait_for_sipi)
         return;
     cpu_x86_load_seg_cache_sipi(s->cpu, s->sipi_vector);
